<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Obras Públicas - Dados Abertos MG</title>
    
    <!-- ==================== ESTILOS E BIBLIOTECAS ==================== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==================== CSS IDÊNTICO AO DASHBOARD DE ACORDOS ==================== */
        :root {
            --primary-dark: #29435A;
            --primary-darker: #0E2F44;
            --accent-red: #B93C42;
            --accent-bright: #DB233F;
            --background-light: #EEEFF5;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --info-blue: #17a2b8;
            --secondary-teal: #20B2AA;
            --hover-blue: #006a82;
        }
        
        body {
            font-family: 'Montserrat', Segoe UI, sans-serif;
            background-color: var(--background-light);
            padding-bottom: 15px;
            overflow-x: hidden;
        }
        
        .main-header {
            background: linear-gradient(135deg, var(--primary-darker) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 12px 0;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--accent-red);
        }
        
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo {
            width: 45px; height: 45px;
            background: linear-gradient(135deg, var(--accent-red), var(--accent-bright));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }
        
        .header-title { font-weight: 700; font-size: 18px; margin: 0; }
        
        .nav-tabs-container {
            background: white; border-radius: 10px; padding: 12px;
            margin-bottom: 20px; box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            overflow-x: auto;
        }
        
        .nav-tabs {
            border: none !important; gap: 4px; flex-wrap: nowrap;
            min-width: max-content; padding-bottom: 5px;
        }
        
        .nav-tabs .nav-link {
            border: none !important; border-radius: 6px !important;
            padding: 10px 15px !important; font-weight: 600;
            color: var(--primary-dark) !important;
            display: inline-flex !important; align-items: center;
            background: none !important;
            font-size: 13px;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: rgba(41,67,90,0.05) !important;
            color: var(--accent-red) !important;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker)) !important;
            color: white !important;
        }
        
        .nav-tabs .nav-link .material-icons { 
            font-size: 18px !important; 
            margin-right: 8px;
        }
        
        .filter-container {
            background: white; border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08); padding: 20px;
            margin-bottom: 20px; border-left: 5px solid var(--accent-red);
        }
        
        .filter-label {
            font-weight: 600; color: var(--primary-dark);
            margin-bottom: 6px; font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef; border-radius: 6px;
            padding: 10px 12px; font-size: 13px;
            transition: all 0.3s ease; height: 42px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 2px rgba(185,60,66,0.15);
        }
        
        .metric-card {
            background: white; border-radius: 10px; padding: 20px 15px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            border-top: 4px solid var(--accent-red); transition: 0.3s;
            height: 100%; position: relative; cursor: default;
        }
        
        .metric-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
        .metric-card.success { border-top-color: var(--success-green); }
        .metric-card.info { border-top-color: var(--info-blue); }
        .metric-card.primary { border-top-color: var(--primary-dark); }
        
        .metric-value { font-size: 24px; font-weight: 700; color: var(--primary-dark); margin: 8px 0; }
        .metric-label { font-size: 12px; color: var(--primary-darker); font-weight: 600; text-transform: uppercase; }
        
        .dashboard-3 {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 20px; margin-bottom: 30px;
        }
        
        .dashboard-2 {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; margin-bottom: 30px;
        }
        
        .card-chart {
            background: #fff; border-radius: 14px; border: 1px solid #e9ecef;
            padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            height: 320px; display: flex; flex-direction: column;
        }
        
        .card-chart h3 {
            margin: 0 0 16px 0; color: #1a1f36; font-size: 16px;
            font-weight: 700; padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f9;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-chart h3 .material-icons {
            font-size: 20px;
            color: var(--accent-red);
        }
        
        .chart-wrapper { flex: 1; min-width: 190px; height: 190px; position: relative; }
        
        .table-container {
            background: white; border-radius: 10px; overflow: hidden;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06); border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .table-fixed-header-container {
            max-height: 500px; overflow-y: auto; position: relative;
        }
        
        .table-fixed-header-container table thead {
            position: sticky; top: 0; z-index: 10;
        }
        
        .table thead th {
            background-color: var(--primary-dark) !important;
            color: white !important; font-weight: 600;
            padding: 12px 10px; font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.3px;
            white-space: nowrap; border: none;
            border-left: 1px solid rgba(255,255,255,0.2) !important;
            border-right: 1px solid rgba(255,255,255,0.2) !important;
            cursor: pointer;
            user-select: none;
        }
        
        .table thead th:first-child { border-left: none !important; }
        .table thead th:last-child { border-right: none !important; }
        
        .sort-icon {
            opacity: 0.8;
            margin-left: 4px;
            font-size: 12px;
            transition: opacity 0.2s ease;
            color: white;
        }
        
        .table thead th:hover {
            background-color: var(--primary-darker) !important;
        }
        
        .table thead th:hover .sort-icon {
            opacity: 1;
        }
        
        .table thead th.sorted-asc .sort-icon::after {
            content: "▲";
            font-size: 12px;
        }
        
        .table thead th.sorted-desc .sort-icon::after {
            content: "▼";
            font-size: 12px;
        }
        
        .table tbody td {
            padding: 12px 10px; vertical-align: middle;
            font-size: 13px; border-bottom: 1px solid #f1f1f1;
        }
        
        .table tbody tr:hover { background-color: rgba(41,67,90,0.04); }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .tag-andamento {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(255,193,7,0.1); color: #856404;
        }
        
        .tag-concluida {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(40,167,69,0.1); color: var(--success-green);
        }
        
        .tag-encerrado {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(23,162,184,0.1); color: var(--info-blue);
        }
        
        .tag-paralisada {
            display: inline-block; padding: 4px 8px; border-radius: 12px;
            font-size: 11px; font-weight: 600;
            background-color: rgba(185,60,66,0.1); color: var(--accent-red);
        }
        
        .btn-primary-custom {
            background: linear-gradient(to right, var(--accent-red), var(--accent-bright));
            border: none; padding: 10px 20px; font-weight: 600;
            border-radius: 6px; transition: all 0.3s ease;
            font-size: 13px; color: white;
            display: inline-flex; align-items: center; gap: 6px;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(to right, var(--primary-darker), var(--hover-blue));
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,123,255,0.2);
            color: white;
        }
        
        .btn-secondary-custom {
            background: white; border: 2px solid var(--primary-darker);
            color: var(--primary-dark); padding: 10px 20px;
            font-weight: 600; border-radius: 6px; transition: all 0.3s ease;
            font-size: 13px; display: inline-flex; align-items: center; gap: 6px;
        }
        
        .btn-secondary-custom:hover {
            background-color: var(--primary-dark); color: white;
            transform: translateY(-1px);
        }
        
        .btn-export {
            background: white; border: 2px solid var(--primary-darker);
            color: var(--primary-dark); padding: 8px 15px;
            border-radius: 6px; font-weight: 600; font-size: 12px;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-export:hover {
            background: var(--primary-dark); color: white;
            transform: translateY(-1px);
        }
        
        .btn-sm-custom {
            padding: 6px 16px;
            font-size: 12px;
        }
        
        .actions-container {
            background: white; border-radius: 10px;
            padding: 15px 20px; margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 12px;
        }
        
        .export-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .right-aligned-container { display: flex; align-items: center; gap: 15px; margin-left: auto; }
        
        .table-badge {
            background: var(--accent-red); color: white;
            padding: 4px 12px; border-radius: 15px;
            font-size: 12px; font-weight: 600;
        }
        
        .pagination-container {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-top: 1px solid #dee2e6;
            background-color: white; flex-wrap: wrap; gap: 10px;
        }
        
        .pagination .page-link {
            border: 1px solid #dee2e6; color: var(--primary-dark);
            padding: 6px 10px; font-weight: 600; font-size: 12px;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark); color: white;
        }
        
        .items-per-page {
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; color: var(--primary-dark); font-weight: 600;
        }
        
        .items-per-page select {
            border: 2px solid rgba(41,67,90,0.3); border-radius: 6px;
            padding: 5px 10px; font-size: 12px; width: auto;
            background-color: white; color: var(--primary-dark);
        }
        
        .search-box-container {
            display: flex; align-items: center; gap: 10px;
            background: white; padding: 8px 12px; border-radius: 6px;
        }
        
        .search-box-container label {
            font-weight: 600; color: var(--primary-dark);
            font-size: 12px; white-space: nowrap;
        }
        
        .search-box-container input {
            border: 2px solid var(--primary-dark) !important;
            border-radius: 6px !important; padding: 8px 12px !important;
            font-size: 13px !important; width: 100% !important;
            max-width: 300px !important; background: white;
        }
        
        .orgao-link {
            color: var(--primary-darker); text-decoration: none;
            font-weight: 600; cursor: pointer; transition: all 0.2s ease;
            padding: 2px 4px; border-radius: 4px;
        }
        
        .orgao-link:hover {
            color: var(--accent-red) !important;
            background-color: rgba(185,60,66,0.05);
            transform: translateY(-1px); text-decoration: none !important;
        }
        
        .btn-action {
            padding: 4px 8px; font-size: 11px; border-radius: 4px;
            border: none; cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 3px;
            background-color: var(--primary-dark); color: white;
        }
        
        .btn-action:hover {
            background-color: var(--primary-darker); transform: translateY(-1px);
        }
        
        .btn-action .material-icons {
            font-size: 16px !important;
        }
        
        .data-atualizacao-container {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px; padding: 10px 0;
        }
        
        .data-atualizacao-box {
            background: white; border-radius: 8px; padding: 8px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; color: var(--primary-dark); font-weight: 600;
        }
        
        .data-atualizacao-box .material-icons {
            font-size: 16px;
            color: var(--accent-red);
        }
        
        .modal-creative {
            border-radius: 15px; overflow: hidden; border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-creative .modal-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
            color: white; padding: 20px 30px; border-bottom: none;
            position: relative;
        }
        
        .modal-creative .modal-header::after {
            content: ''; position: absolute; bottom: -10px; left: 50%;
            transform: translateX(-50%); width: 80px; height: 3px;
            background: linear-gradient(90deg, var(--accent-red), var(--success-green));
            border-radius: 2px;
        }
        
        .modal-creative .modal-title {
            font-weight: 700; font-size: 1.4rem;
            display: flex; align-items: center; gap: 10px;
        }
        
        .modal-creative .modal-title .material-icons {
            font-size: 28px !important;
        }
        
        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        
        .info-card {
            background: white; border-radius: 10px; padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left: 4px solid var(--accent-red); transition: transform 0.3s ease;
        }
        
        .info-card:hover { transform: translateY(-5px); }
        
        .info-label {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #6c757d;
            font-weight: 600; margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 14px; font-weight: 600;
            color: var(--primary-dark); word-break: break-word;
        }
        
        .objeto-container {
            background: white; border-radius: 10px; padding: 25px;
            margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-top: 4px solid var(--success-green);
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: flex;
            justify-content: center; align-items: center; z-index: 9999;
            display: none;
        }
        
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(41,67,90,0.1);
            border-radius: 50%; border-top-color: var(--accent-red);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .progresso-barra {
            width: 80px; height: 6px; background-color: #e9ecef;
            border-radius: 3px; overflow: hidden;
        }
        
        .progresso-preenchimento {
            height: 100%; background-color: var(--success-green);
            border-radius: 3px;
        }
        
        .filter-actions-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 15px;
        }
        
        .objeto-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ===== COMPARTILHAMENTO HOVER ===== */
        .share-dropdown { position: relative; display: inline-block; }
        
        .share-options {
            position: absolute; top: 100%; right: 0;
            background: white; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px; z-index: 1000;
            display: none; padding: 8px 0;
            border: 1px solid #dee2e6;
        }
        
        .share-options.show { display: block; }
        
        .share-option {
            padding: 10px 15px; display: flex; align-items: center;
            gap: 10px; color: var(--primary-dark);
            text-decoration: none; font-size: 13px; font-weight: 600;
            transition: all 0.2s ease; border: none;
            background: none; width: 100%; text-align: left;
        }
        
        .share-option:hover {
            background-color: var(--background-light);
            color: var(--accent-red);
        }
        
        .share-option i { width: 20px; text-align: center; }
        
        .share-option.facebook-share:hover { background-color: #3b5998; color: white; }
        .share-option.twitter-share:hover { background-color: #1da1f2; color: white; }
        .share-option.linkedin-share:hover { background-color: #0077b5; color: white; }
        .share-option.whatsapp-share:hover { background-color: #25d366; color: white; }
        .share-option.link-share:hover { background-color: var(--primary-dark); color: white; }
        
        /* ===== DOWNLOADS CARD ===== */
        .downloads-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-top: 15px;
        }
        
        .download-item {
            background: white; border-radius: 10px; padding: 15px;
            border: 1px solid #e9ecef; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px;
        }
        
        .download-item:hover {
            border-color: var(--accent-red);
            box-shadow: 0 4px 12px rgba(185,60,66,0.1);
            transform: translateY(-2px);
        }
        
        .download-check {
            width: 20px; height: 20px; accent-color: var(--accent-red);
            cursor: pointer;
        }
        
        .download-icon {
            width: 36px; height: 36px;
            background: rgba(41,67,90,0.1); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: var(--primary-dark); font-size: 18px;
        }
        
        .download-info { flex: 1; display: flex; flex-direction: column; }
        .download-filename { font-weight: 700; font-size: 13px; color: var(--primary-dark); margin-bottom: 2px; }
        .download-meta { font-size: 11px; color: #6c757d; }
        
        .download-select-all {
            background: white; border-radius: 10px; padding: 12px 20px;
            border: 2px dashed var(--primary-dark); margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: all 0.2s ease;
        }
        
        .download-select-all:hover {
            background: rgba(41,67,90,0.02);
            border-color: var(--accent-red);
        }
        
        /* ===== LINKS CARDS ===== */
        .links-grid-3 {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 20px; margin-bottom: 20px;
        }
        
        .links-grid-2 {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; margin-bottom: 30px;
        }
        
        .link-card {
            background: white; border-radius: 12px; padding: 20px;
            text-align: center; box-shadow: 0 3px 12px rgba(0,0,0,0.04);
            border: 1px solid #e9ecef; transition: all 0.3s ease;
            height: 100%; display: flex; flex-direction: column;
        }
        
        .link-card:hover {
            transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            border-color: var(--accent-red);
        }
        
        .link-icon {
            width: 64px; height: 64px; background: var(--background-light);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; margin: 0 auto 15px;
            color: var(--primary-dark); font-size: 28px;
        }
        
        .link-card:hover .link-icon {
            background: var(--accent-red); color: white;
        }
        
        .link-title {
            font-weight: 700; color: var(--primary-dark);
            margin-bottom: 8px; font-size: 16px;
        }
        
        .link-desc {
            font-size: 12px; color: #6c757d; margin-bottom: 15px;
            flex: 1;
        }
        
        .link-button {
            background: white; border: 2px solid var(--primary-dark);
            color: var(--primary-dark); padding: 8px 15px;
            border-radius: 6px; font-weight: 600; font-size: 12px;
            text-decoration: none; transition: all 0.2s ease;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 6px; margin-top: auto;
        }
        
        .link-button:hover {
            background: var(--primary-dark); color: white;
        }
        
        .link-button .material-icons {
            font-size: 16px !important;
        }
        
        @media (max-width: 992px) {
            .dashboard-3, .dashboard-2, .links-grid-3 { grid-template-columns: 1fr; }
            .links-grid-2 { grid-template-columns: 1fr; }
        }
        
        /* ===== LEGENDA DO GRÁFICO ===== */
        .legend-compact {
            flex: 0 0 170px;
            max-width: 190px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            padding-right: 6px;
            max-height: 200px;
        }
        
        .legend-item-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
            background: #fafbfd;
        }
        
        .legend-item-compact:hover {
            background-color: #fff;
            border-color: #e2e6eb;
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .legend-dot-compact {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .legend-label-compact {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .legend-content-compact {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .legend-stats-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .legend-percent-compact {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-dark);
        }
        
        .legend-count-compact {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-red);
            background-color: rgba(185,60,66,0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .legend-bar-mini {
            height: 4px;
            background-color: #f1f3f9;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .legend-bar-fill-mini {
            height: 100%;
            border-radius: 2px;
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: 1.25fr 0.75fr;
            gap: 16px;
            flex: 1;
            min-height: 0;
            align-items: center;
        }
    </style>
</head>
<body>



    <div class="container" style="margin-top: 20px;"> <!-- ← ESPAÇAMENTO ADICIONADO AQUI -->


            <!-- ==================== MENU DE NAVEGAÇÃO ==================== -->
            <div class="nav-tabs-container">
                <ul class="nav nav-tabs" id="obrasTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-geral" data-bs-toggle="tab" data-bs-target="#geral">
                            <span class="material-icons">bar_chart</span>Visão Geral
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-contratos" data-bs-toggle="tab" data-bs-target="#contratos">
                            <span class="material-icons">assignment</span>Contratos
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-fiscais" data-bs-toggle="tab" data-bs-target="#fiscais">
                            <span class="material-icons">badge</span>Fiscais
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-valores" data-bs-toggle="tab" data-bs-target="#valores">
                            <span class="material-icons">attach_money</span>Valores
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-downloads" data-bs-toggle="tab" data-bs-target="#downloads">
                            <span class="material-icons">downloading</span>Downloads
                        </button>
                    </li>
                </ul>
            </div>

            <!-- ==================== DATA DE ATUALIZAÇÃO CENTRALIZADA (ÚNICA) ==================== -->
            <div class="data-atualizacao-container">
                <div class="data-atualizacao-box">
                    <span class="material-icons">update</span>
                    Atualizado em: <span id="data-atualizacao-header">Carregando...</span>
                </div>
            </div>

            <!-- ==================== CONTEÚDO DAS ABAS ==================== -->
            <div class="tab-content">
                
                <!-- ========== VISÃO GERAL ========== -->
                <div class="tab-pane fade show active" id="geral">
                    <!-- DATA REMOVIDA DAQUI - AGORA APENAS CENTRALIZADA -->
                    
                    <div class="filter-container">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="filter-label">Ano</label>
                                <select class="form-select" id="anoFiltroGeral">
                                    <option value="">Todos os Anos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="filter-label">Situação</label>
                                <select class="form-select" id="situacaoFiltroGeral">
                                    <option value="">Todas as Situações</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="filter-label">Órgão</label>
                                <input class="form-control" list="orgaosListGeral" id="orgaoFiltroGeral" placeholder="Digite ou selecione...">
                                <datalist id="orgaosListGeral"></datalist>
                            </div>
                            <div class="col-md-3">
                                <label class="filter-label">Município</label>
                                <input class="form-control" list="municipiosListGeral" id="municipioFiltroGeral" placeholder="Digite ou selecione...">
                                <datalist id="municipiosListGeral"></datalist>
                            </div>
                        </div>
                        <div class="filter-actions-row">
                            <button class="btn-primary-custom" id="aplicarFiltrosGeral">
                                <span class="material-icons">search</span>Pesquisar
                            </button>
                            <button class="btn-secondary-custom" id="limparFiltrosGeral">
                                <span class="material-icons">clear</span>Limpar Filtros
                            </button>
                        </div>
                    </div>

                    <!-- Cards de Métricas -->
                    <div class="row mb-4" id="summaryCardsGeral"></div>

                    <!-- GRÁFICOS -->
                    <div class="dashboard-3">
                        <div class="card-chart">
                            <h3>
                                <span class="material-icons">pie_chart</span>
                                Situação das Obras
                            </h3>
                            <div class="chart-row">
                                <div class="chart-wrapper">
                                    <canvas id="chartSituacaoGeral"></canvas>
                                </div>
                                <div class="legend-compact" id="legendSituacaoGeral"></div>
                            </div>
                        </div>
                        <div class="card-chart">
                            <h3>
                                <span class="material-icons">show_chart</span>
                                Investimento por Ano
                            </h3>
                            <div class="chart-wrapper">
                                <canvas id="chartAnoGeral"></canvas>
                            </div>
                        </div>
                        <div class="card-chart">
                            <h3>
                                <span class="material-icons">apartment</span>
                                Top 5 Órgãos
                            </h3>
                            <div class="chart-wrapper">
                                <canvas id="chartOrgaoGeral"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="actions-container">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVGeral">
                                <i class="fas fa-file-csv"></i>Exportar CSV
                            </button>
                            <button class="btn-export" id="printGeral">
                                <i class="fas fa-print"></i>Imprimir
                            </button>
                            <div class="share-dropdown">
                                <button class="btn-share btn-export" id="shareGeral">
                                    <i class="fas fa-share-alt"></i> Compartilhar
                                </button>
                                <div class="share-options" id="shareOptionsGeral">
                                    <a href="#" class="share-option link-share" onclick="copiarLink(event)">
                                        <i class="fas fa-link"></i> Copiar Link
                                    </a>
                                    <a href="#" class="share-option facebook-share" onclick="compartilharFacebook(event)">
                                        <i class="fab fa-facebook-f"></i> Facebook
                                    </a>
                                    <a href="#" class="share-option twitter-share" onclick="compartilharTwitter(event)">
                                        <i class="fab fa-twitter"></i> Twitter
                                    </a>
                                    <a href="#" class="share-option linkedin-share" onclick="compartilharLinkedIn(event)">
                                        <i class="fab fa-linkedin-in"></i> LinkedIn
                                    </a>
                                    <a href="#" class="share-option whatsapp-share" onclick="compartilharWhatsApp(event)">
                                        <i class="fab fa-whatsapp"></i> WhatsApp
                                    </a>
                                </div>
                            </div>
                        </div>                    
                        <div class="right-aligned-container">
                            <div class="items-per-page">
                                <span>Itens/página:</span>
                                <select id="itemsPerPageGeral">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <span class="table-badge" id="resumoCountGeral">0 órgãos</span>
                        </div>
                    </div>

                    <!-- Tabela Resumo por Órgão (SEM RODAPÉ DE TOTAIS) -->
                    <div class="table-container">
                        <div class="table-fixed-header-container">
                            <table class="table table-hover" id="visaoGeralTable">
                                <thead>
                                    <tr>
                                        <th data-sort="orgao" data-order="asc">
                                            Órgão/Entidade <span class="sort-icon"></span>
                                        </th>
                                        <th data-sort="total" data-order="desc" class="text-center">
                                            Total <span class="sort-icon"></span>
                                        </th>
                                        <th data-sort="andamento" data-order="desc" class="text-center">
                                            Andamento <span class="sort-icon"></span>
                                        </th>
                                        <th data-sort="concluidas" data-order="desc" class="text-center">
                                            Concluídas <span class="sort-icon"></span>
                                        </th>
                                        <th data-sort="encerradas" data-order="desc" class="text-center">
                                            Encerradas <span class="sort-icon"></span>
                                        </th>
                                        <th data-sort="valor" data-order="desc" class="text-right">
                                            Valor Total (R$) <span class="sort-icon"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="resumoTableBody"></tbody>
                                <!-- RODAPÉ REMOVIDO - Apenas paginação -->
                            </table>
                        </div>
                        <div class="pagination-container">
                            <div class="pagination-info" id="paginationInfoGeral"></div>
                            <nav>
                                <ul class="pagination mb-0" id="paginationGeral"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- ========== CONTRATOS ========== -->
                <div class="tab-pane fade" id="contratos">
                    <div class="filter-container">
                        <div class="row">
                            <div class="col-md-2">
                                <label class="filter-label">Ano</label>
                                <select class="form-select" id="anoFiltroContrato">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="filter-label">Situação</label>
                                <select class="form-select" id="situacaoFiltroContrato">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="filter-label">Nº Contrato</label>
                                <input type="text" class="form-control" id="numeroContrato" placeholder="Digite ou pesquise...">
                            </div>
                            <div class="col-md-2">
                                <label class="filter-label">Portal Compras</label>
                                <input type="text" class="form-control" id="portalComprasFiltro" placeholder="Nº processo...">
                            </div>
                            <div class="col-md-2">
                                <label class="filter-label">Empresa</label>
                                <input class="form-control" list="empresasList" id="empresaContrato" placeholder="Digite...">
                                <datalist id="empresasList"></datalist>
                            </div>
                            <div class="col-md-2">
                                <label class="filter-label">Órgão</label>
                                <input class="form-control" list="orgaosListContrato" id="orgaoFiltroContrato" placeholder="Digite...">
                                <datalist id="orgaosListContrato"></datalist>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <label class="filter-label">Município</label>
                                <input class="form-control" list="municipiosListContrato" id="municipioFiltroContrato" placeholder="Digite...">
                                <datalist id="municipiosListContrato"></datalist>
                            </div>
                            <div class="col-md-6">
                                <label class="filter-label">Objeto (palavra-chave)</label>
                                <input type="text" class="form-control" id="objetoBusca" placeholder="Ex: pavimentação, ponte...">
                            </div>
                        </div>
                        <div class="filter-actions-row">
                            <button class="btn-primary-custom" id="pesquisarContratos">
                                <span class="material-icons">search</span>Pesquisar
                            </button>
                            <button class="btn-secondary-custom" id="limparFiltrosContratos">
                                <span class="material-icons">clear</span>Limpar Filtros
                            </button>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="actions-container">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVContratos">
                                <i class="fas fa-file-csv"></i>Exportar CSV
                            </button>
                            <button class="btn-export" id="printContratos">
                                <i class="fas fa-print"></i>Imprimir
                            </button>
                            <div class="share-dropdown">
                                <button class="btn-share btn-export" id="shareContratos">
                                    <i class="fas fa-share-alt"></i> Compartilhar
                                </button>
                                <div class="share-options" id="shareOptionsContratos">
                                    <a href="#" class="share-option link-share" onclick="copiarLink(event)"><i class="fas fa-link"></i> Copiar Link</a>
                                    <a href="#" class="share-option facebook-share" onclick="compartilharFacebook(event)"><i class="fab fa-facebook-f"></i> Facebook</a>
                                    <a href="#" class="share-option twitter-share" onclick="compartilharTwitter(event)"><i class="fab fa-twitter"></i> Twitter</a>
                                    <a href="#" class="share-option linkedin-share" onclick="compartilharLinkedIn(event)"><i class="fab fa-linkedin-in"></i> LinkedIn</a>
                                    <a href="#" class="share-option whatsapp-share" onclick="compartilharWhatsApp(event)"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                                </div>
                            </div>
                        </div>
                        <div class="right-aligned-container">
                            <div class="search-box-container">
                                <label for="searchContratos">Buscar:</label>
                                <input type="text" id="searchContratos" placeholder="Contrato, órgão, empresa...">
                            </div>
                            <div class="items-per-page">
                                <span>Itens/página:</span>
                                <select id="itemsPerPageContratos">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <span class="table-badge" id="resumoCountContratos">0 contratos</span>
                        </div>
                    </div>

                    <!-- Tabela de Contratos (SEM RODAPÉ DE TOTAIS) -->
                    <div class="table-container">
                        <div class="table-fixed-header-container">
                            <table class="table table-hover" id="contratosTable">
                                <thead>
                                    <tr>
                                        <th data-sort="contrato" data-order="asc">Contrato <span class="sort-icon"></span></th>
                                        <th data-sort="portal" data-order="asc">Portal Compras <span class="sort-icon"></span></th>
                                        <th data-sort="ano" data-order="desc">Ano <span class="sort-icon"></span></th>
                                        <th data-sort="orgao" data-order="asc">Órgão <span class="sort-icon"></span></th>
                                        <th data-sort="empresa" data-order="asc">Empresa <span class="sort-icon"></span></th>
                                        <th data-sort="objeto" data-order="asc">Objeto <span class="sort-icon"></span></th>
                                        <th data-sort="inicio" data-order="desc">Início <span class="sort-icon"></span></th>
                                        <th data-sort="termino" data-order="desc">Término <span class="sort-icon"></span></th>
                                        <th data-sort="situacao" data-order="asc">Situação <span class="sort-icon"></span></th>
                                        <th class="actions-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="contratosTableBody"></tbody>
                                <!-- RODAPÉ REMOVIDO -->
                            </table>
                        </div>
                        <div class="pagination-container">
                            <div class="pagination-info" id="paginationInfoContratos"></div>
                            <nav>
                                <ul class="pagination mb-0" id="paginationContratos"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- ========== FISCAIS ========== -->
                <div class="tab-pane fade" id="fiscais">
                    <div class="filter-container">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="filter-label">Fiscal</label>
                                <input class="form-control" list="fiscaisList" id="fiscalNome" placeholder="Digite o nome...">
                                <datalist id="fiscaisList"></datalist>
                            </div>
                            <div class="col-md-4">
                                <label class="filter-label">Contrato</label>
                                <input class="form-control" id="fiscalContrato" placeholder="Ex: DE-011/2021">
                            </div>
                            <div class="col-md-4">
                                <label class="filter-label">Órgão</label>
                                <input class="form-control" list="orgaosListFiscal" id="fiscalOrgao" placeholder="Digite...">
                                <datalist id="orgaosListFiscal"></datalist>
                            </div>
                        </div>
                        <div class="filter-actions-row">
                            <button class="btn-primary-custom" id="pesquisarFiscais">
                                <span class="material-icons">search</span>Pesquisar
                            </button>
                            <button class="btn-secondary-custom" id="limparFiltrosFiscais">
                                <span class="material-icons">clear</span>Limpar
                            </button>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="actions-container">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVFiscais">
                                <i class="fas fa-file-csv"></i>Exportar CSV
                            </button>
                            <button class="btn-export" id="printFiscais">
                                <i class="fas fa-print"></i>Imprimir
                            </button>
                            <div class="share-dropdown">
                                <button class="btn-share btn-export" id="shareFiscais">
                                    <i class="fas fa-share-alt"></i> Compartilhar
                                </button>
                                <div class="share-options" id="shareOptionsFiscais">
                                    <a href="#" class="share-option link-share" onclick="copiarLink(event)"><i class="fas fa-link"></i> Copiar Link</a>
                                    <a href="#" class="share-option facebook-share" onclick="compartilharFacebook(event)"><i class="fab fa-facebook-f"></i> Facebook</a>
                                    <a href="#" class="share-option twitter-share" onclick="compartilharTwitter(event)"><i class="fab fa-twitter"></i> Twitter</a>
                                    <a href="#" class="share-option linkedin-share" onclick="compartilharLinkedIn(event)"><i class="fab fa-linkedin-in"></i> LinkedIn</a>
                                    <a href="#" class="share-option whatsapp-share" onclick="compartilharWhatsApp(event)"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                                </div>
                            </div>
                        </div>
                        <div class="right-aligned-container">
                            <div class="search-box-container">
                                <label>Buscar:</label>
                                <input type="text" id="searchFiscais" placeholder="Fiscal, contrato...">
                            </div>
                            <div class="items-per-page">
                                <span>Itens/página:</span>
                                <select id="itemsPerPageFiscais">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <span class="table-badge" id="resumoCountFiscais">0 registros</span>
                        </div>
                    </div>

                    <!-- Tabela de Fiscais (SEM RODAPÉ DE TOTAIS) -->
                    <div class="table-container">
                        <div class="table-fixed-header-container">
                            <table class="table table-hover" id="fiscaisTable">
                                <thead>
                                    <tr>
                                        <th data-sort="fiscal" data-order="asc">Fiscal <span class="sort-icon"></span></th>
                                        <th data-sort="conselho" data-order="asc">Conselho <span class="sort-icon"></span></th>
                                        <th data-sort="cargo" data-order="asc">Cargo <span class="sort-icon"></span></th>
                                        <th data-sort="contrato" data-order="asc">Contrato <span class="sort-icon"></span></th>
                                        <th data-sort="obra" data-order="asc">Obra <span class="sort-icon"></span></th>
                                        <th class="actions-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="fiscaisTableBody"></tbody>
                                <!-- RODAPÉ REMOVIDO -->
                            </table>
                        </div>
                        <div class="pagination-container">
                            <div class="pagination-info" id="paginationInfoFiscais"></div>
                            <nav>
                                <ul class="pagination mb-0" id="paginationFiscais"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- ========== VALORES ========== -->
                <div class="tab-pane fade" id="valores">
                    <!-- GRÁFICOS -->
                    <div class="dashboard-2">
                        <div class="card-chart">
                            <h3>
                                <span class="material-icons">show_chart</span>
                                Valor Inicial por Ano
                            </h3>
                            <div class="chart-wrapper">
                                <canvas id="chartValoresInicial"></canvas>
                            </div>
                        </div>
                        <div class="card-chart">
                            <h3>
                                <span class="material-icons">bar_chart</span>
                                Valor Total por Ano
                            </h3>
                            <div class="chart-wrapper">
                                <canvas id="chartValoresTotal"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="actions-container">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVValores">
                                <i class="fas fa-file-csv"></i>Exportar CSV
                            </button>
                            <button class="btn-export" id="printValores">
                                <i class="fas fa-print"></i>Imprimir
                            </button>
                            <div class="share-dropdown">
                                <button class="btn-share btn-export" id="shareValores">
                                    <i class="fas fa-share-alt"></i> Compartilhar
                                </button>
                                <div class="share-options" id="shareOptionsValores">
                                    <a href="#" class="share-option link-share" onclick="copiarLink(event)"><i class="fas fa-link"></i> Copiar Link</a>
                                    <a href="#" class="share-option facebook-share" onclick="compartilharFacebook(event)"><i class="fab fa-facebook-f"></i> Facebook</a>
                                    <a href="#" class="share-option twitter-share" onclick="compartilharTwitter(event)"><i class="fab fa-twitter"></i> Twitter</a>
                                    <a href="#" class="share-option linkedin-share" onclick="compartilharLinkedIn(event)"><i class="fab fa-linkedin-in"></i> LinkedIn</a>
                                    <a href="#" class="share-option whatsapp-share" onclick="compartilharWhatsApp(event)"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                                </div>
                            </div>
                        </div>
                        <div class="right-aligned-container">
                            <div class="search-box-container">
                                <label>Buscar:</label>
                                <input type="text" id="searchValores" placeholder="Contrato, tipo de obra...">
                            </div>
                            <div class="items-per-page">
                                <span>Itens/página:</span>
                                <select id="itemsPerPageValores">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <span class="table-badge" id="resumoCountValores">0 obras</span>
                        </div>
                    </div>

                    <!-- Tabela de Valores (SEM RODAPÉ DE TOTAIS) -->
                    <div class="table-container">
                        <div class="table-fixed-header-container">
                            <table class="table table-hover" id="valoresTable">
                                <thead>
                                    <tr>
                                        <th data-sort="contrato" data-order="asc">Contrato <span class="sort-icon"></span></th>
                                        <th data-sort="tipo" data-order="asc">Tipo de Obra <span class="sort-icon"></span></th>
                                        <th data-sort="inicial" data-order="desc">Valor Inicial (R$) <span class="sort-icon"></span></th>
                                        <th data-sort="aditivos" data-order="desc">Aditivos (R$) <span class="sort-icon"></span></th>
                                        <th data-sort="total" data-order="desc">Valor Total (R$) <span class="sort-icon"></span></th>
                                        <th data-sort="medido" data-order="desc">Medido (R$) <span class="sort-icon"></span></th>
                                        <th data-sort="saldo" data-order="desc">Saldo (R$) <span class="sort-icon"></span></th>
                                        <th data-sort="percentual" data-order="desc">% Exec. <span class="sort-icon"></span></th>
                                        <th class="actions-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="valoresTableBody"></tbody>
                                <!-- RODAPÉ REMOVIDO -->
                            </table>
                        </div>
                        <div class="pagination-container">
                            <div class="pagination-info" id="paginationInfoValores"></div>
                            <nav>
                                <ul class="pagination mb-0" id="paginationValores"></ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- ========== DOWNLOADS ========== -->
                <div class="tab-pane fade" id="downloads">
                    <!-- Links Institucionais: 3 + 2 -->
                    <div class="links-grid-3">
                        <div class="link-card">
                            <div class="link-icon"><span class="material-icons">dashboard</span></div>
                            <h5 class="link-title">Painel de Obras</h5>
                            <p class="link-desc">Relatórios Trimestrais, medições e fotos, com acompanhamento físico-financeiro</p>
                            <a href="https://app.powerbi.com/view?r=eyJrIjoiMzkwZGM3MGItZGUyNS00NGMzLThkY2YtNTNhYzk0OGYwMzM5IiwidCI6IjUyZTU3MzMxLWYyNzgtNGNhMC05NmZkLTk0YzVhYjFmODUyNCJ9" target="_blank" class="link-button">
                                <span class="material-icons">open_in_new</span> Acessar Painel
                            </a>
                        </div>
                        <div class="link-card">
                            <div class="link-icon"><span class="material-icons">map</span></div>
                            <h5 class="link-title">Mapa de Obras - DER</h5>
                            <p class="link-desc">Visualização georreferenciada de todas as obras rodoviárias</p>
                            <a href="https://portal.der.mg.gov.br/obras-gov-map/#/map" target="_blank" class="link-button">
                                <span class="material-icons">map</span> Acessar Mapa
                            </a>
                        </div>
                        <div class="link-card">
                            <div class="link-icon"><span class="material-icons">gavel</span></div>
                            <h5 class="link-title">Editais de Licitação</h5>
                            <p class="link-desc">Concorrências 2026 - DER/MG</p>
                            <a href="https://www.der.mg.gov.br/transparencia/licitacoes/concorrencias-2026" target="_blank" class="link-button">
                                <span class="material-icons">description</span> Acessar Editais
                            </a>
                        </div>
                    </div>
                    
                    <div class="links-grid-2">
                        <div class="link-card">
                            <div class="link-icon"><span class="material-icons">open_in_new</span></div>
                            <h5 class="link-title">Portal Dados Abertos</h5>
                            <p class="link-desc">dados.mg.gov.br - Conjuntos de dados governamentais</p>
                            <a href="https://dados.mg.gov.br/dataset/" target="_blank" class="link-button">
                                <span class="material-icons">open_in_new</span> Acessar Portal
                            </a>
                        </div>
                        <div class="link-card">
                            <div class="link-icon"><i class="fab fa-github"></i></div>
                            <h5 class="link-title">Repositório GitHub</h5>
                            <p class="link-desc">transparencia-mg/obras - Código e dados abertos</p>
                            <a href="https://github.com/transparencia-mg/obras" target="_blank" class="link-button">
                                <i class="fab fa-github"></i> Acessar Repositório
                            </a>
                        </div>
                    </div>

                    <!-- Área de Download Aprimorada -->
                    <div class="filter-container">
                        <h4 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">database</span> Baixar Conjunto de Dados
                        </h4>
                        
                        <div class="download-select-all" id="selectAllDownloads">
                            <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                <input type="checkbox" id="checkAllDownloads" class="download-check" checked>
                                <label for="checkAllDownloads" style="font-weight: 600; color: var(--primary-dark); cursor: pointer; flex: 1;">
                                    <strong>Selecionar todos os arquivos</strong>
                                    <span style="display: block; font-size: 12px; font-weight: normal; color: #6c757d;">6 arquivos disponíveis no repositório oficial</span>
                                </label>
                                <div class="d-flex gap-2">
                                    <button class="btn-primary-custom" id="downloadSelecionadosZip">
                                        <span class="material-icons">archive</span> Baixar ZIP
                                    </button>
                                    <button class="btn-secondary-custom" id="downloadAllCSV">
                                        <span class="material-icons">download</span> Todos
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="downloads-grid" id="downloadsGrid">
                            <div class="download-item" data-file="contratos">
                                <input type="checkbox" class="download-check" id="dlContratos" checked>
                                <div class="download-icon"><span class="material-icons">description</span></div>
                                <div class="download-info">
                                    <span class="download-filename">contratos.csv</span>
                                    <span class="download-meta">Contratos e valores · ~2.500 registros</span>
                                </div>
                            </div>
                            <div class="download-item" data-file="obras">
                                <input type="checkbox" class="download-check" id="dlObras" checked>
                                <div class="download-icon"><span class="material-icons">construction</span></div>
                                <div class="download-info">
                                    <span class="download-filename">obras.csv</span>
                                    <span class="download-meta">Detalhamento por obra · ~1.200 registros</span>
                                </div>
                            </div>
                            <div class="download-item" data-file="fiscais">
                                <input type="checkbox" class="download-check" id="dlFiscais" checked>
                                <div class="download-icon"><span class="material-icons">badge</span></div>
                                <div class="download-info">
                                    <span class="download-filename">fiscais.csv</span>
                                    <span class="download-meta">Fiscais designados · ~3.800 registros</span>
                                </div>
                            </div>
                            <div class="download-item" data-file="municipios">
                                <input type="checkbox" class="download-check" id="dlMunicipios" checked>
                                <div class="download-icon"><span class="material-icons">location_city</span></div>
                                <div class="download-info">
                                    <span class="download-filename">municipios.csv</span>
                                    <span class="download-meta">Obra × Município · ~2.100 registros</span>
                                </div>
                            </div>
                            <div class="download-item" data-file="coordenadas">
                                <input type="checkbox" class="download-check" id="dlCoordenadas" checked>
                                <div class="download-icon"><span class="material-icons">pin_drop</span></div>
                                <div class="download-info">
                                    <span class="download-filename">coordenadas.csv</span>
                                    <span class="download-meta">Geolocalização · ~800 registros</span>
                                </div>
                            </div>
                            <div class="download-item" data-file="trechos">
                                <input type="checkbox" class="download-check" id="dlTrechos" checked>
                                <div class="download-icon"><span class="material-icons">signpost</span></div>
                                <div class="download-info">
                                    <span class="download-filename">trechos.csv</span>
                                    <span class="download-meta">Trechos rodoviários · ~1.500 registros</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-4 mb-0">
                            <div class="d-flex align-items-center gap-3">
                                <span class="material-icons" style="font-size: 32px; color: var(--primary-dark);">sync</span>
                                <div>
                                    <strong>Atualização Automática</strong><br>
                                    <span style="font-size: 13px;">Dados sincronizados diretamente do repositório GitHub. Última atualização: <span id="downloadUpdateTime">carregando...</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== MODAL DE DETALHES ENRIQUECIDO ==================== -->
    <div class="modal fade" id="detalhesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content modal-creative">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="material-icons">assignment</span> Detalhes do Contrato e Obra
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalhesContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary-custom" data-bs-dismiss="modal">
                        <span class="material-icons">close</span> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== LOADING OVERLAY ==================== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // =============================================
        // DASHBOARD DE OBRAS - DADOS REAIS DO GITHUB
        // VERSÃO FINAL - DATA ÚNICA, SEM TOTAIS NO RODAPÉ
        // =============================================
        const BASE_URL = 'https://raw.githubusercontent.com/transparencia-mg/obras/main/dataset/data/';
        const ARQUIVOS = {
            contratos: 'contratos.csv',
            obras: 'obras.csv',
            fiscais: 'fiscais.csv',
            municipios: 'municipios.csv',
            coordenadas: 'coordenadas.csv',
            trechos: 'trechos.csv'
        };

        // ========== ESTADO GLOBAL ==========
        let dados = { contratos: [], obras: [], fiscais: [], municipios: [], coordenadas: [], trechos: [] };
        let dadosFiltrados = { contratos: [], fiscais: [], valores: [] };
        
        let paginacao = {
            geral: { page: 1, itemsPerPage: 50 },
            contratos: { page: 1, itemsPerPage: 50 },
            fiscais: { page: 1, itemsPerPage: 50 },
            valores: { page: 1, itemsPerPage: 50 }
        };
        
        let charts = {};
        
        // ========== ESTADO DE ORDENAÇÃO ==========
        let sortState = {
            geral: { column: 'total', order: 'desc' },
            contratos: { column: 'ano', order: 'desc' },
            fiscais: { column: 'fiscal', order: 'asc' },
            valores: { column: 'total', order: 'desc' }
        };

        // ========== FUNÇÕES DE COMPARTILHAMENTO ==========
        window.copiarLink = function(e) { 
            e?.preventDefault(); 
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link copiado para a área de transferência!');
            }).catch(() => { 
                let ta = document.createElement('textarea'); 
                ta.value = window.location.href; 
                document.body.appendChild(ta); 
                ta.select(); 
                document.execCommand('copy'); 
                document.body.removeChild(ta); 
                alert('Link copiado para a área de transferência!'); 
            });
        };
        
        window.compartilharFacebook = (e) => { e.preventDefault(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank'); };
        window.compartilharTwitter = (e) => { e.preventDefault(); window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent('Painel de Obras - Minas Gerais')}`, '_blank'); };
        window.compartilharLinkedIn = (e) => { e.preventDefault(); window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`, '_blank'); };
        window.compartilharWhatsApp = (e) => { e.preventDefault(); window.open(`https://wa.me/?text=${encodeURIComponent('Confira o Painel de Obras - MG: ' + window.location.href)}`, '_blank'); };
        
        function toggleShareDropdown(id) {
            document.querySelectorAll('.share-options').forEach(opt => opt.classList.remove('show'));
            document.getElementById(id)?.classList.add('show');
        }
        
        document.addEventListener('click', (e) => { 
            if (!e.target.closest('.share-dropdown')) {
                document.querySelectorAll('.share-options').forEach(opt => opt.classList.remove('show'));
            }
        });

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', () => {
            showLoading(true);
            atualizarDataHeader();
            carregarTodosArquivos();
            configurarEventListeners();
            configurarOrdenacao();
        });

        function atualizarDataHeader() {
            const agora = new Date();
            const dataStr = agora.toLocaleDateString('pt-BR') + ' ' + agora.toLocaleTimeString('pt-BR');
            
            // Atualiza apenas a data centralizada única
            const headerEl = document.getElementById('data-atualizacao-header');
            if (headerEl) headerEl.innerText = dataStr;
            
            // Atualiza também o rodapé dos downloads, se existir
            const downloadEl = document.getElementById('downloadUpdateTime');
            if (downloadEl) downloadEl.innerText = dataStr;
        }

        function showLoading(show) { 
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; 
        }

        // ========== CARREGAMENTO DOS 6 CSVS ==========
        async function carregarTodosArquivos() {
            try {
                const promises = Object.entries(ARQUIVOS).map(([key, filename]) =>
                    fetch(BASE_URL + filename)
                        .then(res => res.text())
                        .then(csv => new Promise(resolve => {
                            Papa.parse(csv, {
                                delimiter: ';', 
                                header: true, 
                                skipEmptyLines: true,
                                transformHeader: h => h.toLowerCase()
                                    .trim()
                                    .normalize('NFD')
                                    .replace(/[\u0300-\u036f]/g, '')
                                    .replace(/[^a-z0-9_]/g, '_'),
                                complete: (result) => { 
                                    dados[key] = result.data.filter(r => Object.values(r).some(v => v?.toString().trim())); 
                                    resolve(); 
                                }
                            });
                        }))
                );
                await Promise.all(promises);
                processarDados();
                inicializarFiltros();
                atualizarVisaoGeral();
                atualizarTabelaContratos();
                atualizarFiscais();
                atualizarValores();
                showLoading(false);
            } catch (error) { 
                console.error('Erro fatal:', error); 
                showLoading(false); 
                alert('Erro ao carregar dados. Tente novamente mais tarde.'); 
            }
        }

        // ========== PROCESSAMENTO E RELACIONAMENTOS ==========
        function processarDados() {
            // Normalização de valores numéricos - Contratos
            dados.contratos = dados.contratos.map(c => ({
                ...c,
                contrato: c.contrato?.trim() || '',
                portal_de_compras: c.portal_de_compras?.trim() || '',
                valor_inicial_do_contrato: parseFloat(String(c.valor_inicial_do_contrato || '0').replace(',', '.')) || 0,
                valor_total_do_contrato: parseFloat(String(c.valor_total_do_contrato || '0').replace(',', '.')) || 0,
                percentual_execucao_contrato: parseFloat(String(c.percentual_execucao_contrato || '0').replace(',', '.')) || 0,
                ano_assinatura: c.data_assinatura ? c.data_assinatura.split('-')[0] : ''
            }));

            // Normalização - Obras
            dados.obras = dados.obras.map(o => ({
                ...o, 
                contrato: o.contrato?.trim() || '', 
                obra: o.obra?.trim() || '',
                valor_inicial_da_obra: parseFloat(String(o.valor_inicial_da_obra || '0').replace(',', '.')) || 0,
                valor_total_da_obra: parseFloat(String(o.valor_total_da_obra || '0').replace(',', '.')) || 0,
                valor_medido_precos_iniciais: parseFloat(String(o.valor_medido_precos_iniciais || '0').replace(',', '.')) || 0,
                saldo_de_valor_da_obra: parseFloat(String(o.saldo_de_valor_da_obra || '0').replace(',', '.')) || 0
            }));

            // Normalização - Relacionamentos
            dados.fiscais = dados.fiscais.map(f => ({ ...f, contrato: f.contrato?.trim() || '' }));
            dados.municipios = dados.municipios.map(m => ({ ...m, contrato: m.contrato?.trim() || '' }));
            dados.coordenadas = dados.coordenadas.map(coord => ({ ...coord, contrato: coord.contrato?.trim() || '' }));
            dados.trechos = dados.trechos.map(t => ({ ...t, contrato: t.contrato?.trim() || '' }));

            // Vincular dados aos contratos
            dados.contratos.forEach(c => {
                c.obras_vinculadas = dados.obras.filter(o => o.contrato === c.contrato);
                c.municipios_vinculados = dados.municipios.filter(m => m.contrato === c.contrato).map(m => m.municipio).filter(Boolean).join('; ');
                c.fiscais_vinculados = dados.fiscais.filter(f => f.contrato === c.contrato).map(f => f.nome).filter(Boolean).join('; ');
                c.coordenadas_vinculadas = dados.coordenadas.filter(coord => coord.contrato === c.contrato);
                c.trechos_vinculados = dados.trechos.filter(t => t.contrato === c.contrato);
            });

            dadosFiltrados.contratos = [...dados.contratos];
            dadosFiltrados.fiscais = [...dados.fiscais];
            dadosFiltrados.valores = [...dados.obras];
        }

        // ========== INICIALIZAR FILTROS ==========
        function inicializarFiltros() {
            const anos = [...new Set(dados.contratos.map(c => c.ano_assinatura).filter(Boolean))].sort((a,b)=>b-a);
            const orgaos = [...new Set(dados.contratos.map(c => c.orgao_entidade_contratante).filter(Boolean))].sort();
            const situacoes = [...new Set(dados.contratos.map(c => c.situacao).filter(Boolean))].sort();
            const municipios = [...new Set(dados.municipios.map(m => m.municipio).filter(Boolean))].sort();
            const empresas = [...new Set(dados.contratos.map(c => c.empresa).filter(Boolean))].sort();
            const fiscais = [...new Set(dados.fiscais.map(f => f.nome).filter(Boolean))].sort();

            preencherSelect('anoFiltroGeral', anos); 
            preencherSelect('anoFiltroContrato', anos);
            preencherSelect('situacaoFiltroGeral', situacoes); 
            preencherSelect('situacaoFiltroContrato', situacoes);
            
            preencherDatalist('orgaosListGeral', orgaos); 
            preencherDatalist('orgaosListContrato', orgaos); 
            preencherDatalist('orgaosListFiscal', orgaos);
            preencherDatalist('municipiosListGeral', municipios); 
            preencherDatalist('municipiosListContrato', municipios);
            preencherDatalist('empresasList', empresas); 
            preencherDatalist('fiscaisList', fiscais);
        }
        
        function preencherSelect(id, valores) { 
            let s = document.getElementById(id); 
            if(s){ 
                s.innerHTML = '<option value="">Todos</option>'; 
                valores.forEach(v => s.innerHTML += `<option value="${v}">${v}</option>`); 
            } 
        }
        
        function preencherDatalist(id, valores) { 
            let d = document.getElementById(id); 
            if(d) d.innerHTML = valores.map(v => `<option value="${v}">`).join(''); 
        }

        // ========== FUNÇÕES DE ORDENAÇÃO ==========
        function configurarOrdenacao() {
            document.querySelectorAll('#visaoGeralTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    if (sortState.geral.column === column) {
                        sortState.geral.order = sortState.geral.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.geral.column = column;
                        sortState.geral.order = column === 'orgao' ? 'asc' : 'desc';
                    }
                    atualizarVisaoGeral();
                    atualizarIconesOrdenacao('visaoGeralTable', sortState.geral);
                });
            });

            document.querySelectorAll('#contratosTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    if (sortState.contratos.column === column) {
                        sortState.contratos.order = sortState.contratos.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.contratos.column = column;
                        sortState.contratos.order = column === 'contrato' || column === 'orgao' ? 'asc' : 'desc';
                    }
                    atualizarTabelaContratos();
                    atualizarIconesOrdenacao('contratosTable', sortState.contratos);
                });
            });

            document.querySelectorAll('#fiscaisTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    if (sortState.fiscais.column === column) {
                        sortState.fiscais.order = sortState.fiscais.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.fiscais.column = column;
                        sortState.fiscais.order = 'asc';
                    }
                    atualizarFiscais();
                    atualizarIconesOrdenacao('fiscaisTable', sortState.fiscais);
                });
            });

            document.querySelectorAll('#valoresTable th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    if (sortState.valores.column === column) {
                        sortState.valores.order = sortState.valores.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.valores.column = column;
                        sortState.valores.order = 'desc';
                    }
                    atualizarValores();
                    atualizarIconesOrdenacao('valoresTable', sortState.valores);
                });
            });
        }

        function atualizarIconesOrdenacao(tableId, state) {
            const headers = document.querySelectorAll(`#${tableId} th[data-sort]`);
            headers.forEach(th => {
                const icon = th.querySelector('.sort-icon');
                const column = th.getAttribute('data-sort');
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (column === state.column) {
                    th.classList.add(`sorted-${state.order}`);
                }
            });
        }

        // ========== FUNÇÕES DE ORDENAÇÃO (LÓGICA) ==========
        function ordenarArray(array, column, order, tipo) {
            return [...array].sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'orgao': valA = a.orgao || ''; valB = b.orgao || ''; break;
                    case 'total': valA = a.total || 0; valB = b.total || 0; break;
                    case 'andamento': valA = a.andamento || 0; valB = b.andamento || 0; break;
                    case 'concluidas': valA = a.concluidas || 0; valB = b.concluidas || 0; break;
                    case 'encerradas': valA = a.encerradas || 0; valB = b.encerradas || 0; break;
                    case 'valor': valA = a.valor || 0; valB = b.valor || 0; break;
                    case 'contrato': valA = a.contrato || ''; valB = b.contrato || ''; break;
                    case 'portal': valA = a.portal_de_compras || ''; valB = b.portal_de_compras || ''; break;
                    case 'ano': valA = parseInt(a.ano_assinatura) || 0; valB = parseInt(b.ano_assinatura) || 0; break;
                    case 'empresa': valA = a.empresa || ''; valB = b.empresa || ''; break;
                    case 'objeto': valA = a.objeto || ''; valB = b.objeto || ''; break;
                    case 'inicio': valA = a.data_assinatura || ''; valB = b.data_assinatura || ''; break;
                    case 'termino': valA = a.termino_execucao || ''; valB = b.termino_execucao || ''; break;
                    case 'situacao': valA = a.situacao || ''; valB = b.situacao || ''; break;
                    case 'fiscal': valA = a.nome || ''; valB = b.nome || ''; break;
                    case 'conselho': valA = a.conselho || ''; valB = b.conselho || ''; break;
                    case 'cargo': valA = a.cargo || ''; valB = b.cargo || ''; break;
                    case 'obra': valA = a.obra || ''; valB = b.obra || ''; break;
                    case 'tipo': valA = a.detipoobra || ''; valB = b.detipoobra || ''; break;
                    case 'inicial': valA = a.valor_inicial_da_obra || 0; valB = b.valor_inicial_da_obra || 0; break;
                    case 'aditivos': valA = (a.valor_total_da_obra || 0) - (a.valor_inicial_da_obra || 0); valB = (b.valor_total_da_obra || 0) - (b.valor_inicial_da_obra || 0); break;
                    case 'total': valA = a.valor_total_da_obra || 0; valB = b.valor_total_da_obra || 0; break;
                    case 'medido': valA = a.valor_medido_precos_iniciais || 0; valB = b.valor_medido_precos_iniciais || 0; break;
                    case 'saldo': valA = a.saldo_de_valor_da_obra || 0; valB = b.saldo_de_valor_da_obra || 0; break;
                    case 'percentual':
                        valA = a.valor_total_da_obra ? ((a.valor_total_da_obra - (a.saldo_de_valor_da_obra||0)) / a.valor_total_da_obra * 100) : 0;
                        valB = b.valor_total_da_obra ? ((b.valor_total_da_obra - (b.saldo_de_valor_da_obra||0)) / b.valor_total_da_obra * 100) : 0;
                        break;
                    default: valA = a[column] || ''; valB = b[column] || '';
                }

                const orderMultiplier = order === 'asc' ? 1 : -1;
                
                if (typeof valA === 'string') {
                    return orderMultiplier * valA.localeCompare(valB);
                } else {
                    return orderMultiplier * (valA - valB);
                }
            });
        }

        // ========== FUNÇÕES DE FILTRO ==========
        function filtrarContratos() {
            let filtrados = [...dados.contratos];
            
            const ano = document.getElementById('anoFiltroContrato')?.value;
            const sit = document.getElementById('situacaoFiltroContrato')?.value;
            const num = document.getElementById('numeroContrato')?.value;
            const portal = document.getElementById('portalComprasFiltro')?.value;
            const emp = document.getElementById('empresaContrato')?.value;
            const orgao = document.getElementById('orgaoFiltroContrato')?.value;
            const mun = document.getElementById('municipioFiltroContrato')?.value;
            const obj = document.getElementById('objetoBusca')?.value;

            if (ano) filtrados = filtrados.filter(c => c.ano_assinatura === ano);
            if (sit) filtrados = filtrados.filter(c => c.situacao === sit);
            if (num) filtrados = filtrados.filter(c => c.contrato?.toLowerCase().includes(num.toLowerCase()));
            if (portal) filtrados = filtrados.filter(c => c.portal_de_compras?.toLowerCase().includes(portal.toLowerCase()));
            if (emp) filtrados = filtrados.filter(c => c.empresa?.toLowerCase().includes(emp.toLowerCase()));
            if (orgao) filtrados = filtrados.filter(c => c.orgao_entidade_contratante?.toLowerCase().includes(orgao.toLowerCase()));
            if (obj) filtrados = filtrados.filter(c => c.objeto?.toLowerCase().includes(obj.toLowerCase()));
            if (mun) { 
                let cc = dados.municipios.filter(m => m.municipio?.toLowerCase().includes(mun.toLowerCase())).map(m => m.contrato); 
                filtrados = filtrados.filter(c => cc.includes(c.contrato)); 
            }

            dadosFiltrados.contratos = filtrados;
            paginacao.contratos.page = 1;
            atualizarTabelaContratos();
        }

        function filtrarFiscais() {
            let filtrados = [...dados.fiscais];
            
            const nome = document.getElementById('fiscalNome')?.value;
            const contrato = document.getElementById('fiscalContrato')?.value;
            const orgao = document.getElementById('fiscalOrgao')?.value;

            if (nome) filtrados = filtrados.filter(f => f.nome?.toLowerCase().includes(nome.toLowerCase()));
            if (contrato) filtrados = filtrados.filter(f => f.contrato?.toLowerCase().includes(contrato.toLowerCase()));
            if (orgao) { 
                let cc = dados.contratos.filter(c => c.orgao_entidade_contratante?.toLowerCase().includes(orgao.toLowerCase())).map(c => c.contrato); 
                filtrados = filtrados.filter(f => cc.includes(f.contrato)); 
            }
            
            dadosFiltrados.fiscais = filtrados;
            paginacao.fiscais.page = 1;
            atualizarFiscais();
        }

        function filtrarValores() {
            let filtrados = [...dados.obras];
            const termo = document.getElementById('searchValores')?.value?.toLowerCase();
            if (termo) filtrados = filtrados.filter(o => 
                o.contrato?.toLowerCase().includes(termo) || 
                o.detipoobra?.toLowerCase().includes(termo)
            );
            dadosFiltrados.valores = filtrados;
            paginacao.valores.page = 1;
            atualizarValores();
        }

        // ========== VISÃO GERAL ==========
        function atualizarVisaoGeral() {
            let dadosVG = dados.contratos;
            
            const ano = document.getElementById('anoFiltroGeral')?.value;
            const sit = document.getElementById('situacaoFiltroGeral')?.value;
            const orgao = document.getElementById('orgaoFiltroGeral')?.value;
            const mun = document.getElementById('municipioFiltroGeral')?.value;

            if (ano) dadosVG = dadosVG.filter(c => c.ano_assinatura === ano);
            if (sit) dadosVG = dadosVG.filter(c => c.situacao === sit);
            if (orgao) dadosVG = dadosVG.filter(c => c.orgao_entidade_contratante?.toLowerCase().includes(orgao.toLowerCase()));
            if (mun) { 
                let cc = dados.municipios.filter(m => m.municipio?.toLowerCase().includes(mun.toLowerCase())).map(m => m.contrato); 
                dadosVG = dadosVG.filter(c => cc.includes(c.contrato)); 
            }

            // Cards
            let total = dadosVG.length;
            let andamento = dadosVG.filter(c => c.situacao?.includes('Andamento')).length;
            let concluidas = dadosVG.filter(c => c.situacao?.includes('concluída')).length;
            let encerradas = dadosVG.filter(c => c.situacao?.includes('Encerrado')).length;
            let valorTotal = dadosVG.reduce((a,c)=>a+(c.valor_total_do_contrato||0),0);
            
            document.getElementById('summaryCardsGeral').innerHTML = `
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Total de Contratos</div>
                        <div class="metric-value">${total}</div>
                        <span class="material-icons" style="font-size:14px; color: var(--primary-dark);">assignment</span> Registrados
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card success">
                        <div class="metric-label">Em Andamento</div>
                        <div class="metric-value">${andamento}</div>
                        <span class="metric-change positive">${((andamento/total)*100 || 0).toFixed(1)}%</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card info">
                        <div class="metric-label">Concluídas</div>
                        <div class="metric-value">${concluidas}</div>
                        <span class="material-icons" style="font-size:14px; color: var(--info-blue);">check_circle</span> Entregues
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card primary">
                        <div class="metric-label">Investimento Total</div>
                        <div class="metric-value">R$ ${formatarMoeda(valorTotal)}</div>
                        <span class="material-icons" style="font-size:14px; color: var(--primary-dark);">paid</span> Contratado
                    </div>
                </div>
            `;

            // GRÁFICO DE SITUAÇÃO
            const ctxSit = document.getElementById('chartSituacaoGeral')?.getContext('2d');
            if (ctxSit) {
                if (charts.sitGeral) charts.sitGeral.destroy();
                
                const andamentoCount = dadosVG.filter(c => c.situacao?.includes('Andamento')).length;
                const concluidasCount = dadosVG.filter(c => c.situacao?.includes('concluída')).length;
                const encerradasCount = dadosVG.filter(c => c.situacao?.includes('Encerrado')).length;
                const outrasCount = dadosVG.length - andamentoCount - concluidasCount - encerradasCount;
                
                const data = [andamentoCount, concluidasCount, encerradasCount, outrasCount];
                const labels = ['Em Andamento', 'Concluídas', 'Encerradas', 'Outras'];
                const colors = ['#FFC107', '#28a745', '#17a2b8', '#6c757d'];
                
                charts.sitGeral = new Chart(ctxSit, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const total = ctx.dataset.data.reduce((a,b) => a + b, 0);
                                        const value = ctx.raw;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Renderizar legenda customizada
                const legendEl = document.getElementById('legendSituacaoGeral');
                if (legendEl) {
                    const total = data.reduce((a,b) => a + b, 0);
                    legendEl.innerHTML = labels.map((label, i) => {
                        const value = data[i];
                        const percent = ((value / total) * 100).toFixed(1);
                        return `
                            <div class="legend-item-compact" data-index="${i}">
                                <span class="legend-dot-compact" style="background: ${colors[i]};"></span>
                                <div class="legend-content-compact">
                                    <div class="legend-label-compact">${label}</div>
                                    <div class="legend-stats-compact">
                                        <span class="legend-percent-compact">${percent}%</span>
                                        <span class="legend-count-compact">${value}</span>
                                    </div>
                                    <div class="legend-bar-mini">
                                        <div class="legend-bar-fill-mini" style="width: ${percent}%; background: ${colors[i]};"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Gráfico de Investimento por Ano
            const anosMap = {};
            dadosVG.forEach(c => { 
                if(c.ano_assinatura) anosMap[c.ano_assinatura] = (anosMap[c.ano_assinatura]||0) + (c.valor_total_do_contrato||0); 
            });
            
            const ctxAno = document.getElementById('chartAnoGeral')?.getContext('2d');
            if (ctxAno) {
                if (charts.anoGeral) charts.anoGeral.destroy();
                const anosOrdenados = Object.keys(anosMap).sort();
                charts.anoGeral = new Chart(ctxAno, {
                    type: 'bar',
                    data: {
                        labels: anosOrdenados,
                        datasets: [{
                            data: anosOrdenados.map(a => anosMap[a]),
                            backgroundColor: '#29435A',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `R$ ${formatarMoeda(ctx.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value) => 'R$ ' + formatarMoeda(value)
                                }
                            }
                        }
                    }
                });
            }

            // Gráfico Top 5 Órgãos
            const orgaosCount = {};
            dadosVG.forEach(c => { 
                let o = c.orgao_entidade_contratante || 'Não informado'; 
                orgaosCount[o] = (orgaosCount[o]||0) + 1; 
            });
            
            const topOrgaos = Object.entries(orgaosCount)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 5);
            
            const ctxOrg = document.getElementById('chartOrgaoGeral')?.getContext('2d');
            if (ctxOrg) {
                if (charts.orgaoGeral) charts.orgaoGeral.destroy();
                charts.orgaoGeral = new Chart(ctxOrg, {
                    type: 'bar',
                    data: {
                        labels: topOrgaos.map(o => o[0].length > 25 ? o[0].substring(0,25)+'...' : o[0]),
                        datasets: [{
                            data: topOrgaos.map(o => o[1]),
                            backgroundColor: '#B93C42',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // Tabela resumo por órgão
            const orgaoMap = new Map();
            dadosVG.forEach(c => { 
                let nome = c.orgao_entidade_contratante || 'Não informado'; 
                if(!orgaoMap.has(nome)) orgaoMap.set(nome, { 
                    orgao: nome,
                    total: 0, 
                    andamento: 0, 
                    concluidas: 0, 
                    encerradas: 0, 
                    valor: 0 
                }); 
                let reg = orgaoMap.get(nome); 
                reg.total++; 
                reg.valor += c.valor_total_do_contrato||0; 
                if(c.situacao?.includes('Andamento')) reg.andamento++; 
                else if(c.situacao?.includes('concluída')) reg.concluidas++; 
                else if(c.situacao?.includes('Encerrado')) reg.encerradas++; 
            });
            
            let resumoArray = Array.from(orgaoMap.values());
            
            // Aplicar ordenação
            resumoArray = ordenarArray(resumoArray, sortState.geral.column, sortState.geral.order, 'geral');
            
            let totalOrgaos = resumoArray.length;
            let totalPages = Math.ceil(totalOrgaos / paginacao.geral.itemsPerPage);
            let start = (paginacao.geral.page - 1) * paginacao.geral.itemsPerPage;
            let end = Math.min(start + paginacao.geral.itemsPerPage, totalOrgaos);
            
            document.getElementById('resumoTableBody').innerHTML = resumoArray.slice(start, end).map(item => `
                <tr>
                    <td style="text-align: left;">
                        <a href="#" onclick="filtrarPorOrgao('${item.orgao.replace(/'/g, "\\'")}'); return false;" class="orgao-link">
                            ${item.orgao}
                        </a>
                    </td>
                    <td class="text-center">${item.total}</td>
                    <td class="text-center"><span class="tag-andamento">${item.andamento}</span></td>
                    <td class="text-center"><span class="tag-concluida">${item.concluidas}</span></td>
                    <td class="text-center"><span class="tag-encerrado">${item.encerradas}</span></td>
                    <td class="text-right">R$ ${formatarMoeda(item.valor)}</td>
                </tr>
            `).join('');
            
            document.getElementById('resumoCountGeral').innerText = `${totalOrgaos} órgãos`;
            document.getElementById('paginationInfoGeral').innerText = `Mostrando ${start+1}-${end} de ${totalOrgaos} registros`;
            
            atualizarPaginacao('geral', totalPages);
            atualizarIconesOrdenacao('visaoGeralTable', sortState.geral);
        }

        // ========== TABELA DE CONTRATOS ==========
        function atualizarTabelaContratos() {
            let dadosTab = [...dadosFiltrados.contratos];
            
            // Aplicar ordenação
            dadosTab = ordenarArray(dadosTab, sortState.contratos.column, sortState.contratos.order, 'contratos');
            
            let total = dadosTab.length;
            let pp = paginacao.contratos.itemsPerPage;
            let page = paginacao.contratos.page;
            let totalPages = Math.ceil(total / pp);
            let start = (page - 1) * pp;
            let end = Math.min(start + pp, total);
            
            document.getElementById('contratosTableBody').innerHTML = dadosTab.slice(start, end).map(c => `
                <tr>
                    <td><strong>${c.contrato || '-'}</strong></td>
                    <td>${c.portal_de_compras || '-'}</td>
                    <td>${c.ano_assinatura || '-'}</td>
                    <td>${c.orgao_entidade_contratante || '-'}</td>
                    <td>${c.empresa || '-'}</td>
                    <td class="objeto-cell" title="${c.objeto || ''}">${truncate(c.objeto, 40)}</td>
                    <td>${formatarData(c.data_assinatura)}</td>
                    <td>${formatarData(c.termino_execucao)}</td>
                    <td><span class="${getSituacaoClass(c.situacao)}">${c.situacao || '-'}</span></td>
                    <td class="actions-column">
                        <button class="btn-action" onclick="verDetalhesContrato('${c.contrato}')">
                            <span class="material-icons">visibility</span>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('resumoCountContratos').innerText = `${total} contratos`;
            document.getElementById('paginationInfoContratos').innerText = `Mostrando ${start+1}-${end} de ${total} registros`;
            
            atualizarPaginacao('contratos', totalPages);
            atualizarIconesOrdenacao('contratosTable', sortState.contratos);
        }

        // ========== FISCAIS ==========
        function atualizarFiscais() {
            let dadosTab = [...dadosFiltrados.fiscais];
            
            // Aplicar ordenação
            dadosTab = ordenarArray(dadosTab, sortState.fiscais.column, sortState.fiscais.order, 'fiscais');
            
            let total = dadosTab.length;
            let pp = paginacao.fiscais.itemsPerPage;
            let page = paginacao.fiscais.page;
            let totalPages = Math.ceil(total / pp);
            let start = (page - 1) * pp;
            let end = Math.min(start + pp, total);

            document.getElementById('fiscaisTableBody').innerHTML = dadosTab.slice(start, end).map(f => `
                <tr>
                    <td><strong>${f.nome || '-'}</strong></td>
                    <td>${f.conselho || '-'}</td>
                    <td>${f.cargo || '-'}</td>
                    <td><strong>${f.contrato || '-'}</strong></td>
                    <td>${f.obra || '-'}</td>
                    <td class="actions-column">
                        <button class="btn-action" onclick="verDetalhesContrato('${f.contrato}')">
                            <span class="material-icons">visibility</span>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('resumoCountFiscais').innerText = `${total} registros`;
            document.getElementById('paginationInfoFiscais').innerText = `Mostrando ${start+1}-${end} de ${total} registros`;
            
            atualizarPaginacao('fiscais', totalPages);
            atualizarIconesOrdenacao('fiscaisTable', sortState.fiscais);
        }

        // ========== VALORES ==========
        function atualizarValores() {
            let dadosTab = [...dadosFiltrados.valores];
            
            // Aplicar ordenação
            dadosTab = ordenarArray(dadosTab, sortState.valores.column, sortState.valores.order, 'valores');
            
            let total = dadosTab.length;
            let pp = paginacao.valores.itemsPerPage;
            let page = paginacao.valores.page;
            let totalPages = Math.ceil(total / pp);
            let start = (page - 1) * pp;
            let end = Math.min(start + pp, total);
            
            document.getElementById('valoresTableBody').innerHTML = dadosTab.slice(start, end).map(o => {
                let inicial = o.valor_inicial_da_obra || 0;
                let totalVal = o.valor_total_da_obra || 0;
                let medido = o.valor_medido_precos_iniciais || 0;
                let saldo = o.saldo_de_valor_da_obra || 0;
                let perc = totalVal ? ((totalVal - saldo) / totalVal * 100).toFixed(2) : 0;
                
                return `
                    <tr>
                        <td><strong>${o.contrato || '-'}</strong></td>
                        <td>${o.detipoobra || '-'}</td>
                        <td class="text-right">R$ ${formatarMoeda(inicial)}</td>
                        <td class="text-right">R$ ${formatarMoeda(totalVal - inicial)}</td>
                        <td class="text-right">R$ ${formatarMoeda(totalVal)}</td>
                        <td class="text-right">R$ ${formatarMoeda(medido)}</td>
                        <td class="text-right">R$ ${formatarMoeda(saldo)}</td>
                        <td>
                            <div class="progresso-barra">
                                <div class="progresso-preenchimento" style="width: ${perc}%;"></div>
                            </div>
                            <small>${perc}%</small>
                        </td>
                        <td class="actions-column">
                            <button class="btn-action" onclick="verDetalhesContrato('${o.contrato}')">
                                <span class="material-icons">visibility</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('resumoCountValores').innerText = `${total} obras`;
            document.getElementById('paginationInfoValores').innerText = `Mostrando ${start+1}-${end} de ${total} registros`;
            
            atualizarPaginacao('valores', totalPages);
            atualizarIconesOrdenacao('valoresTable', sortState.valores);
            
            // Gráficos de Valores
            atualizarGraficosValores();
        }

        function atualizarGraficosValores() {
            // Gráfico de Valor Inicial por Ano
            const ctxInicial = document.getElementById('chartValoresInicial')?.getContext('2d');
            if (ctxInicial) {
                if (charts.valoresInicial) charts.valoresInicial.destroy();
                
                const anosInicial = {};
                dados.contratos.forEach(c => {
                    if (c.ano_assinatura) {
                        anosInicial[c.ano_assinatura] = (anosInicial[c.ano_assinatura] || 0) + (c.valor_inicial_do_contrato || 0);
                    }
                });
                
                const anosOrdenados = Object.keys(anosInicial).sort();
                charts.valoresInicial = new Chart(ctxInicial, {
                    type: 'bar',
                    data: {
                        labels: anosOrdenados,
                        datasets: [{
                            data: anosOrdenados.map(a => anosInicial[a]),
                            backgroundColor: '#20B2AA',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `R$ ${formatarMoeda(ctx.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value) => 'R$ ' + formatarMoeda(value)
                                }
                            }
                        }
                    }
                });
            }

            // Gráfico de Valor Total por Ano
            const ctxTotal = document.getElementById('chartValoresTotal')?.getContext('2d');
            if (ctxTotal) {
                if (charts.valoresTotal) charts.valoresTotal.destroy();
                
                const anosTotal = {};
                dados.contratos.forEach(c => {
                    if (c.ano_assinatura) {
                        anosTotal[c.ano_assinatura] = (anosTotal[c.ano_assinatura] || 0) + (c.valor_total_do_contrato || 0);
                    }
                });
                
                const anosOrdenados = Object.keys(anosTotal).sort();
                charts.valoresTotal = new Chart(ctxTotal, {
                    type: 'bar',
                    data: {
                        labels: anosOrdenados,
                        datasets: [{
                            data: anosOrdenados.map(a => anosTotal[a]),
                            backgroundColor: '#29435A',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `R$ ${formatarMoeda(ctx.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value) => 'R$ ' + formatarMoeda(value)
                                }
                            }
                        }
                    }
                });
            }
        }

        // ========== DOWNLOADS ==========
        document.getElementById('selectAllDownloads')?.addEventListener('click', function(e) { 
            if(e.target.type !== 'checkbox') { 
                let cb = document.getElementById('checkAllDownloads'); 
                cb.checked = !cb.checked; 
                document.querySelectorAll('.download-item .download-check').forEach(c => c.checked = cb.checked); 
            } 
        });
        
        document.getElementById('checkAllDownloads')?.addEventListener('change', function(e) { 
            document.querySelectorAll('.download-item .download-check').forEach(c => c.checked = e.target.checked); 
        });
        
        document.querySelectorAll('.download-item .download-check').forEach(cb => {
            cb.addEventListener('change', function() { 
                let all = document.querySelectorAll('.download-item .download-check'); 
                let allChecked = document.getElementById('checkAllDownloads'); 
                allChecked.checked = [...all].every(c => c.checked); 
                allChecked.indeterminate = [...all].some(c => c.checked) && !allChecked.checked; 
            });
        });

        document.getElementById('downloadSelecionadosZip')?.addEventListener('click', async function() {
            showLoading(true); 
            const zip = new JSZip();
            
            if (document.getElementById('dlContratos').checked) 
                zip.file('contratos.csv', Papa.unparse(dados.contratos, { delimiter: ';' }));
            if (document.getElementById('dlObras').checked) 
                zip.file('obras.csv', Papa.unparse(dados.obras, { delimiter: ';' }));
            if (document.getElementById('dlFiscais').checked) 
                zip.file('fiscais.csv', Papa.unparse(dados.fiscais, { delimiter: ';' }));
            if (document.getElementById('dlMunicipios').checked) 
                zip.file('municipios.csv', Papa.unparse(dados.municipios, { delimiter: ';' }));
            if (document.getElementById('dlCoordenadas').checked) 
                zip.file('coordenadas.csv', Papa.unparse(dados.coordenadas, { delimiter: ';' }));
            if (document.getElementById('dlTrechos').checked) 
                zip.file('trechos.csv', Papa.unparse(dados.trechos, { delimiter: ';' }));
            
            const content = await zip.generateAsync({ type: 'blob' }); 
            saveAs(content, 'obras_mg_dados_completos.zip'); 
            showLoading(false);
        });
        
        document.getElementById('downloadAllCSV')?.addEventListener('click', function() { 
            document.querySelectorAll('.download-item .download-check').forEach(c => c.checked = true); 
            document.getElementById('checkAllDownloads').checked = true; 
            document.getElementById('downloadSelecionadosZip').click(); 
        });

        // ========== MODAL DE DETALHES ENRIQUECIDO (COM COORDENADAS CORRIGIDAS) ==========
        window.verDetalhesContrato = function(contratoId) {
            let c = dados.contratos.find(c => c.contrato === contratoId); 
            if (!c) return;
            
            let obras = dados.obras.filter(o => o.contrato === contratoId);
            let fiscais = dados.fiscais.filter(f => f.contrato === contratoId);
            let municipios = dados.municipios.filter(m => m.contrato === contratoId);
            let coordenadas = dados.coordenadas.filter(coord => coord.contrato === contratoId);
            let trechos = dados.trechos.filter(t => t.contrato === contratoId);
            
            // CORREÇÃO: Filtrar coordenadas válidas (latitude e longitude não vazias)
            let primeiraCoord = coordenadas.find(coord => 
                coord.latitude && coord.longitude && 
                coord.latitude.trim() !== '' && 
                coord.longitude.trim() !== '' &&
                !isNaN(parseFloat(coord.latitude.replace(',', '.'))) &&
                !isNaN(parseFloat(coord.longitude.replace(',', '.')))
            );
            
            let lat = primeiraCoord ? parseFloat(primeiraCoord.latitude.replace(',', '.')).toFixed(6) : null;
            let lng = primeiraCoord ? parseFloat(primeiraCoord.longitude.replace(',', '.')).toFixed(6) : null;
            
            let content = document.getElementById('detalhesContent');
            content.innerHTML = `
                <div class="info-grid">
                    <div class="info-card primary">
                        <div class="info-label">Contrato</div>
                        <div class="info-value highlight">${c.contrato || '-'}</div>
                        <div class="info-label mt-2">Ano</div>
                        <div class="info-value">${c.ano_assinatura || '-'}</div>
                    </div>
                    <div class="info-card success">
                        <div class="info-label">Situação</div>
                        <div><span class="${getSituacaoClass(c.situacao)}">${c.situacao || '-'}</span></div>
                        <div class="info-label mt-2">Empresa</div>
                        <div class="info-value">${c.empresa || '-'}</div>
                    </div>
                    <div class="info-card warning">
                        <div class="info-label">Órgão</div>
                        <div class="info-value">${c.orgao_entidade_contratante || '-'}</div>
                        <div class="info-label mt-2">Vigência</div>
                        <div class="info-value">${formatarData(c.data_assinatura)} a ${formatarData(c.termino_execucao)}</div>
                    </div>
                    <div class="info-card info">
                        <div class="info-label">Valor Contratado</div>
                        <div class="info-value">R$ ${formatarMoeda(c.valor_total_do_contrato)}</div>
                        <div class="info-label mt-2">% Executado</div>
                        <div class="info-value">${((c.percentual_execucao_contrato || 0) * 100).toFixed(2)}%</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-card">
                            <div class="info-label">Portal de Compras</div>
                            <div class="info-value">${c.portal_de_compras || '-'}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card">
                            <div class="info-label">Nº Processo</div>
                            <div class="info-value">${c.portal_de_compras || '-'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="objeto-container">
                    <h5 class="objeto-title">
                        <span class="material-icons">subject</span> Objeto
                    </h5>
                    <div class="objeto-text">${c.objeto || 'Objeto não informado'}</div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-label">Municípios</div>
                            <div class="info-value">${municipios.map(m => m.municipio).join(', ') || 'Não informado'}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-label">Fiscais Designados</div>
                            <div class="info-value" style="max-height: 100px; overflow-y: auto;">
                                ${fiscais.map(f => f.nome).join('<br>') || 'Não informado'}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-label">Localização</div>
                            ${lat && lng ? `
                                <div class="info-value">
                                    <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn-export mt-2" style="display: inline-flex;">
                                        <span class="material-icons">map</span> Ver no Mapa
                                    </a>
                                    <br>
                                    <small>Lat: ${lat} | Lon: ${lng}</small>
                                </div>
                            ` : '<div class="info-value text-muted">Coordenadas não disponíveis</div>'}
                        </div>
                    </div>
                </div>
                
                ${obras.length > 0 ? `
                    <div class="mt-4">
                        <h6 class="fw-bold" style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">construction</span> Obras Vinculadas:
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Obra</th>
                                        <th>Tipo</th>
                                        <th>Valor Total (R$)</th>
                                        <th>Saldo (R$)</th>
                                        <th>% Exec.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${obras.map(o => {
                                        let perc = o.valor_total_da_obra ? 
                                            ((o.valor_total_da_obra - (o.saldo_de_valor_da_obra || 0)) / o.valor_total_da_obra * 100).toFixed(2) : 0;
                                        return `
                                            <tr>
                                                <td>${o.obra}</td>
                                                <td>${o.detipoobra || '-'}</td>
                                                <td class="text-right">R$ ${formatarMoeda(o.valor_total_da_obra)}</td>
                                                <td class="text-right">R$ ${formatarMoeda(o.saldo_de_valor_da_obra)}</td>
                                                <td>${perc}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
                
                ${trechos.length > 0 ? `
                    <div class="mt-3">
                        <h6 class="fw-bold" style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">signpost</span> Trechos Rodoviários:
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Rodovia</th>
                                        <th>Descrição</th>
                                        <th>KM Inicial</th>
                                        <th>KM Final</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trechos.slice(0, 5).map(t => `
                                        <tr>
                                            <td>${t.rodovia || '-'}</td>
                                            <td>${t.descricao_trecho || '-'}</td>
                                            <td>${t.km_inicial || '-'}</td>
                                            <td>${t.km_final || '-'}</td>
                                        </tr>
                                    `).join('')}
                                    ${trechos.length > 5 ? 
                                        '<tr><td colspan="4" class="text-muted">... mais ' + (trechos.length - 5) + ' trechos</td></tr>' : 
                                        ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
            
            new bootstrap.Modal(document.getElementById('detalhesModal')).show();
        };

        // ========== UTILITÁRIOS ==========
        window.filtrarPorOrgao = function(orgao) { 
            document.getElementById('orgaoFiltroContrato').value = orgao; 
            filtrarContratos(); 
            document.querySelector('[data-bs-target="#contratos"]').click(); 
        };
        
        function getSituacaoClass(s) { 
            if(!s) return 'badge bg-secondary'; 
            if(s.includes('Andamento')) return 'tag-andamento'; 
            if(s.includes('concluída')) return 'tag-concluida'; 
            if(s.includes('Encerrado')) return 'tag-encerrado'; 
            if(s.includes('Paralisada')) return 'tag-paralisada'; 
            return 'badge bg-secondary'; 
        }
        
        function formatarMoeda(v) { 
            return (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
        }
        
        function formatarData(d) { 
            return d ? d.split('-').reverse().join('/') : '-'; 
        }
        
        function truncate(s, l) { 
            return s?.length > l ? s.substring(0, l) + '...' : s || '-'; 
        }
        
        function atualizarPaginacao(tipo, totalPages) { 
            let p = paginacao[tipo]; 
            let el = document.getElementById(`pagination${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`); 
            if(!el) return; 
            
            let html = `<li class="page-item ${p.page === 1 ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="mudarPagina('${tipo}', ${p.page - 1})">&laquo;</a>
                        </li>`;
            
            for(let i = 1; i <= totalPages; i++) {
                if(i === 1 || i === totalPages || (i >= p.page - 2 && i <= p.page + 2)) {
                    html += `<li class="page-item ${i === p.page ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="mudarPagina('${tipo}', ${i})">${i}</a>
                            </li>`;
                }
            }
            
            html += `<li class="page-item ${p.page === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="mudarPagina('${tipo}', ${p.page + 1})">&raquo;</a>
                    </li>`;
            
            el.innerHTML = html; 
        }
        
        window.mudarPagina = function(tipo, page) { 
            let totalItems = tipo === 'geral' ? 
                document.querySelectorAll('#resumoTableBody tr').length : 
                tipo === 'contratos' ? dadosFiltrados.contratos.length : 
                tipo === 'fiscais' ? dadosFiltrados.fiscais.length : 
                dadosFiltrados.valores.length; 
            
            let totalPages = Math.ceil(totalItems / paginacao[tipo].itemsPerPage); 
            if(page < 1 || page > totalPages) return; 
            
            paginacao[tipo].page = page; 
            
            if(tipo === 'geral') atualizarVisaoGeral(); 
            else if(tipo === 'contratos') atualizarTabelaContratos(); 
            else if(tipo === 'fiscais') atualizarFiscais(); 
            else if(tipo === 'valores') atualizarValores(); 
        };

        // ========== EVENT LISTENERS ==========
        function configurarEventListeners() {
            // Visão Geral
            document.getElementById('aplicarFiltrosGeral')?.addEventListener('click', () => { 
                paginacao.geral.page = 1; 
                atualizarVisaoGeral(); 
            });
            
            document.getElementById('limparFiltrosGeral')?.addEventListener('click', () => { 
                document.getElementById('anoFiltroGeral').value = ''; 
                document.getElementById('situacaoFiltroGeral').value = ''; 
                document.getElementById('orgaoFiltroGeral').value = ''; 
                document.getElementById('municipioFiltroGeral').value = ''; 
                paginacao.geral.page = 1; 
                atualizarVisaoGeral(); 
            });

            // Contratos
            document.getElementById('pesquisarContratos')?.addEventListener('click', filtrarContratos);
            
            document.getElementById('limparFiltrosContratos')?.addEventListener('click', () => { 
                ['anoFiltroContrato','situacaoFiltroContrato','numeroContrato',
                 'portalComprasFiltro','empresaContrato','orgaoFiltroContrato',
                 'municipioFiltroContrato','objetoBusca'].forEach(id => { 
                    let el = document.getElementById(id); 
                    if(el) el.value = ''; 
                }); 
                dadosFiltrados.contratos = [...dados.contratos]; 
                paginacao.contratos.page = 1; 
                atualizarTabelaContratos(); 
            });
            
            document.getElementById('searchContratos')?.addEventListener('input', function(e) { 
                let t = e.target.value.toLowerCase(); 
                dadosFiltrados.contratos = dados.contratos.filter(c => 
                    c.contrato?.toLowerCase().includes(t) || 
                    c.orgao_entidade_contratante?.toLowerCase().includes(t) || 
                    c.empresa?.toLowerCase().includes(t) || 
                    c.objeto?.toLowerCase().includes(t)
                ); 
                paginacao.contratos.page = 1; 
                atualizarTabelaContratos(); 
            });

            // Fiscais
            document.getElementById('pesquisarFiscais')?.addEventListener('click', filtrarFiscais);
            
            document.getElementById('limparFiltrosFiscais')?.addEventListener('click', () => { 
                document.getElementById('fiscalNome').value = ''; 
                document.getElementById('fiscalContrato').value = ''; 
                document.getElementById('fiscalOrgao').value = ''; 
                dadosFiltrados.fiscais = [...dados.fiscais]; 
                paginacao.fiscais.page = 1; 
                atualizarFiscais(); 
            });
            
            document.getElementById('searchFiscais')?.addEventListener('input', function(e) { 
                let t = e.target.value.toLowerCase(); 
                dadosFiltrados.fiscais = dados.fiscais.filter(f => 
                    f.nome?.toLowerCase().includes(t) || 
                    f.contrato?.toLowerCase().includes(t)
                ); 
                paginacao.fiscais.page = 1; 
                atualizarFiscais(); 
            });

            // Valores
            document.getElementById('searchValores')?.addEventListener('input', function(e) { 
                filtrarValores(); 
            });

            // Items per page
            document.getElementById('itemsPerPageGeral')?.addEventListener('change', e => { 
                paginacao.geral.itemsPerPage = parseInt(e.target.value); 
                paginacao.geral.page = 1; 
                atualizarVisaoGeral(); 
            });
            
            document.getElementById('itemsPerPageContratos')?.addEventListener('change', e => { 
                paginacao.contratos.itemsPerPage = parseInt(e.target.value); 
                paginacao.contratos.page = 1; 
                atualizarTabelaContratos(); 
            });
            
            document.getElementById('itemsPerPageFiscais')?.addEventListener('change', e => { 
                paginacao.fiscais.itemsPerPage = parseInt(e.target.value); 
                paginacao.fiscais.page = 1; 
                atualizarFiscais(); 
            });
            
            document.getElementById('itemsPerPageValores')?.addEventListener('change', e => { 
                paginacao.valores.itemsPerPage = parseInt(e.target.value); 
                paginacao.valores.page = 1; 
                atualizarValores(); 
            });

            // Exportações
            document.getElementById('exportCSVGeral')?.addEventListener('click', () => downloadCSV('visao_geral_obras.csv', dados.contratos));
            document.getElementById('exportCSVContratos')?.addEventListener('click', () => downloadCSV('contratos_filtrados.csv', dadosFiltrados.contratos));
            document.getElementById('exportCSVFiscais')?.addEventListener('click', () => downloadCSV('fiscais_filtrados.csv', dadosFiltrados.fiscais));
            document.getElementById('exportCSVValores')?.addEventListener('click', () => downloadCSV('valores_obras.csv', dados.obras));

            // Share buttons
            document.getElementById('shareGeral')?.addEventListener('click', () => toggleShareDropdown('shareOptionsGeral'));
            document.getElementById('shareContratos')?.addEventListener('click', () => toggleShareDropdown('shareOptionsContratos'));
            document.getElementById('shareFiscais')?.addEventListener('click', () => toggleShareDropdown('shareOptionsFiscais'));
            document.getElementById('shareValores')?.addEventListener('click', () => toggleShareDropdown('shareOptionsValores'));

            // Print
            document.getElementById('printGeral')?.addEventListener('click', () => window.print());
            document.getElementById('printContratos')?.addEventListener('click', () => window.print());
            document.getElementById('printFiscais')?.addEventListener('click', () => window.print());
            document.getElementById('printValores')?.addEventListener('click', () => window.print());
        }
        
        function downloadCSV(filename, data) { 
            const csv = Papa.unparse(data, { delimiter: ';' }); 
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); 
            saveAs(blob, filename); 
        }
    </script>
</body>
</html>